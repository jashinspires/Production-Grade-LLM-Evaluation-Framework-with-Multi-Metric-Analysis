# LLM Evaluation Framework - CI/CD Pipeline
name: LLM Evaluation CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: "3.11"
  POETRY_VERSION: "1.7.1"

jobs:
  # Code quality checks
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install linting tools
        run: |
          pip install black isort flake8 mypy
      
      - name: Run Black
        run: black --check src/ tests/
      
      - name: Run isort
        run: isort --check-only src/ tests/
      
      - name: Run flake8
        run: flake8 src/ tests/ --max-line-length=100 --ignore=E501,W503,E203

  # Unit and integration tests
  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Load cached dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}
      
      - name: Install dependencies
        run: poetry install --no-interaction
      
      - name: Download NLTK data
        run: |
          poetry run python -c "import nltk; nltk.download('punkt'); nltk.download('punkt_tab')"
      
      - name: Run tests with coverage
        env:
          OPENAI_API_KEY: test-key
          ANTHROPIC_API_KEY: test-key
          GROQ_API_KEY: test-key
        run: |
          poetry run pytest tests/ -v \
            --cov=llm_eval \
            --cov-report=xml \
            --cov-report=html \
            --cov-fail-under=80
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: coverage.xml
          fail_ci_if_error: false

  # Build and push Docker image
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Free up disk space
        run: |
          # Remove pre-installed software to free up disk space
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          df -h
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: llm-eval:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Test Docker image
        run: |
          docker run --rm llm-eval:latest llm-eval --help

  # Run evaluation pipeline
  evaluate:
    name: Run Evaluation
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
      
      - name: Install dependencies
        run: poetry install --no-interaction
      
      - name: Download NLTK data
        run: |
          poetry run python -c "import nltk; nltk.download('punkt'); nltk.download('punkt_tab')"
      
      - name: Run evaluation (without LLM judge)
        run: |
          poetry run llm-eval run \
            --config examples/config.yaml \
            --output-dir results/ \
            --metrics bleu,rouge_l,bertscore,faithfulness,context_relevancy,answer_relevancy \
            --no-progress
      
      - name: Upload evaluation results
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-results
          path: results/
      
      - name: Check evaluation quality gates
        run: |
          python -c "
          import json
          import sys
          
          # Load the JSON report
          import glob
          reports = glob.glob('results/evaluation_report_*.json')
          if not reports:
              print('ERROR: No evaluation report found')
              sys.exit(1)
          
          with open(reports[0]) as f:
              report = json.load(f)
          
          # Check minimum score thresholds
          summary = report.get('summary', {})
          overall = summary.get('overall_average', 0)
          
          print(f'Overall average score: {overall:.4f}')
          
          if overall < 0.3:
              print('WARNING: Overall score below threshold')
          
          print('Quality gate passed!')
          "

  # Security scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          severity: 'CRITICAL,HIGH'

  # Create release (on version tags)
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [test, docker]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
